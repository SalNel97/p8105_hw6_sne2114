---
title: "Homework 6 solutions"
author: "Jeff Goldsmith"
date: '`r format(Sys.time(), "%Y-%m-%d")`'
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(modelr)
library(p8105.datasets)
library(viridis)
library(mgcv)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
theme_set(theme_minimal() + theme(legend.position = "bottom"))

knitr::opts_chunk$set(comment = NA, message = FALSE, warning = FALSE, echo = TRUE)
```


### Problem 1

Read in and tidy the data.

```{r}
homicide_df = 
  read_csv("./data/homicide-data.csv", na = c("", "NA", "Unknown")) %>% 
  mutate(
    city_state = str_c(city, state, sep = ", "),
    victim_age = as.numeric(victim_age),
    resolution = case_when(
      disposition == "Closed without arrest" ~ 0,
      disposition == "Open/No arrest"        ~ 0,
      disposition == "Closed by arrest"      ~ 1)
  ) %>% 
  filter(
    victim_race %in% c("White", "Black"),
    city_state != "Tulsa, AL") %>% 
  select(city_state, resolution, victim_age, victim_race, victim_sex)
```


Fitting Logistic Regression for one city, trying to predict resolution of case using victim age, race, and sex.

```{r}
baltimore_df =
  homicide_df %>% 
  filter(city_state == "Baltimore, MD")
glm(resolution ~ victim_age + victim_race + victim_sex, 
    data = baltimore_df,
    family = binomial()) %>% 
  broom::tidy() %>% 
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error)
  ) %>% 
  select(term, OR, starts_with("CI")) %>% 
  knitr::kable(digits = 3)
```


Running this same logistic model across cities.

```{r}
models_results_df = 
  homicide_df %>% 
  nest(data = -city_state) %>% 
  mutate(
    models = 
      map(.x = data, ~glm(resolution ~ victim_age + victim_race + victim_sex, data = .x, family = binomial())),
    results = map(models, broom::tidy)
  ) %>% 
  select(city_state, results) %>% 
  unnest(results) %>% 
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error)
  ) %>% 
  select(city_state, term, OR, starts_with("CI")) 
```

Plotting ORs with 95 CI for each of the cities.

```{r}
models_results_df %>% 
  filter(term == "victim_raceWhite") %>% 
  mutate(city_state = fct_reorder(city_state, OR)) %>% 
  ggplot(aes(x = city_state, y = OR, color = city_state)) + 
  geom_point() + 
  geom_errorbar(aes(ymin = CI_lower, ymax = CI_upper)) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1), legend.position = "none") +
  labs(
    title = "Odds Ratio with 95% CI by City",
    x = "City",
    y = "Odds Ratio") +
  scale_y_continuous(breaks = seq(0, 28, by = 1))
```

It seems like all the ORs are above 1 for every city, meaning the odds of solving a homicide for a white victim are better than the odds of solving a homicide for a black victim. Oakland, Omaha, Boston, and Pittsburgh are the cities with the highest ORs.

## Problem 2

Read in and tidy data set as well as change variables to factors as appropriate. We also checked that all 4342 entries for every variable returns false when checking for missing values.

```{r}
baby_df =
  read_csv("./data/birthweight.csv") %>% 
  janitor::clean_names() %>% 
  mutate(babysex = as.factor(babysex),
         frace = as.factor(frace),
         malform = as.factor(malform),
         mrace = as.factor(mrace))
 
baby_df %>% is.na() %>% summary()

baby_df
```

I have hypothesised a model based on apriori hypotheses which focus on physical and growth attributes for the baby (body length, head circumference, gestational age) and weight attributes of the mother (pre-pregnancy weight, weight at delivery, weight gained during pregnancy) to predict birthweight for the baby. I also thought to include a delwt*wtgain interaction term since weight gained during pregnancy is related to mother's weight at delivery (buit not pre-preganncy weight).

```{r}
my_model = lm(bwt ~ blength + bhead + gaweeks + delwt + ppwt + wtgain + delwt*wtgain, data = baby_df)

baby_df %>% 
  add_residuals(my_model) %>% 
  add_predictions(my_model) %>%
  ggplot(aes(x = pred, y = resid)) + 
  geom_point(alpha = .4) +
  labs(
    title = "Apriori Model",
    x = "Predictions",
    y = "Residuals")
```

Prediction values seem to be concentrated between 2500 and 4000 while the residual values seem to aggregate between -600 and 1000.



```{r}
model_1 = lm(bwt ~ blength + gaweeks, data = baby_df)

baby_df %>% 
  add_residuals(model_1) %>% 
  add_predictions(model_1) %>%
  ggplot(aes(x = pred, y = resid)) + 
  geom_point(alpha = .4) +
  labs(
    title = "Model 1: Baby Body Length and Gestational Age Main Effects Only",
    x = "Predictions",
    y = "Residuals")


model_2 = lm(bwt ~ (blength + bhead + babysex)^2 + blength*bhead*babysex, data = baby_df)

baby_df %>% 
  add_residuals(model_2) %>% 
  add_predictions(model_2) %>%
  ggplot(aes(x = pred, y = resid)) + 
  geom_point(alpha = .4) +
  labs(
    title = "Apriori Model",
    x = "Predictions",
    y = "Residuals")
```

